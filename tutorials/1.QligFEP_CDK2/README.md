1. Ligand Preparation

We start with ligands generated in maestro. PDB files generally. The problem is that we do not have the parameters necessary to run MD simulations. That is why we need ligand preparation. 

"
This folder contains pre-generated 3D-coordinates of the ligand. These coordinates are not generated by setupFEP, we are responsible to get reliable coordinates. It is important to keep in mind that FEP handles well small changes in the system, but if the phase space is not sufficiently overlapping the results become increasingly unreliable. The ligands in this folder are all overlaying similar core region, and small substituents on are investigated. 
For AMBER parameters, please refer to qtools: 
"

### Generate the flies using a script from the script folder. 
`python $qligfep/scripts/generate_opls.py`
This will ==write out the .lib, .prm and .pdb files== needed for stage 3. The .log files are generated by ffld_server. 

[[OPLS]]


2. Protprep
The second step is needed to prepare a protein for simulations under spherical boundary conditions (SBC). Note that this script does not attempt to assign protonation states, so one needs to run a ==preparation step first (e.g. Maestro's Protein Preparation Wizard==). 

The center of the sphere can be based on a residue in the protein, or as in this case by explicitly providing the center of geometry (COG) coordinates from a ligand. E.g. to get those used in this example run:

```
python $qligfep/scripts/COG.py -i ../1.ligprep/17.pdb
```

==add -i before the pdb==

Which returns the coordinates 0.535:26.772:8.819, which can be directly put in protprep.py:

```
python $qligfep/protprep.py -p 1h1s_PrepWiz.pdb -r 22 -c 0.535:26.772:8.819 -w -P CSB
```
*for this step, we should move to the folder containing the 1h1s_PrepWiz.pdb file*

# 3.setupFEP

In the next stage we will prepare the input files for the actual simulations. This stage uses $qligfep/QligFEP.py, you can use the -h flag to get more specifics on all the input variables. This folder includes a useful top level script, generate.py, that takes a .txt file as input that specifies the ligand pairs that will be used in this simulation. You can simply run:

```
python setup.py
```

And this should result in a 1.protein and 2.water folder, containing the two systems necessary to perform the calculation. Simply go into the folder (1.PROTEIN OR 2.WATER) and run

```
./FEP_submit.sh
```

This will either submit your jobs to a slurm queue (see the setup section in $setupFEP/README.md for a more detailed description). Alternatively the jobs can be run on your local machine.

A typical procedure is to put the two systems in a top layer folder to easily track running calculations (e.g. 1.TESTRUN) in the case of this example. Of course, these toplayer scripts can be easily adjusted for any other use (e.g. to calculate solvation free energies, you add a water and vacuum leg, instead of protein water.


## 4. Analyze

Run `python analyze_FEP.py -F tutorials/1.QligFEP_CDK2/3.setupFEP/1.protein/FEP_22-17 -C CSB` from the `QLIGFEP/qligfep` folder. Otherwise it won't work because functions.py cannot be imported. 

The output should look something like this: 

```
dG 1.QligFEP_CDK2 [0.415, nan, nan, -0.491, 0.223, 1.703, nan, nan, nan, nan]
dGf 1.QligFEP_CDK2 [1.14, nan, nan, 0.728, 1.013, 3.119, nan, nan, nan, nan]
dGr 1.QligFEP_CDK2 [0.31, nan, nan, 1.71, 0.567, -0.286, nan, nan, nan, nan]
dGos 1.QligFEP_CDK2 [0.336, nan, nan, -1.049, 0.143, 0.937, nan, nan, nan, nan]
dGbar 1.QligFEP_CDK2 [0.23, nan, nan, -1.115, 0.17, 1.185, nan, nan, nan, nan]
tutorials/1.QligFEP_CDK2/3.setupFEP/1.protein/FEP_22-17   0.46  0.29   1.50  0.35   0.58  0.26   0.09  0.26   0.12  0.30
crashes  1
```
dG, dGf, dGr, dGos and dGbar are different ways Q is calculating dG. Normally we will use dGbar. 

There's 10 values from 10 replicas (runnings).


TO CHANGE NUMBER OF RUNS: 
pwd: `/home/USER/QLIGFEP/qligfep/tutorials/1.QligFEP_CDK2/3.setupFEP/1.protein/FEP_17-22`
and then 
`vim FEP_submit.sh`

TO MAKE SEVERAL CALCULATIONS (=! FOLDERS)
Change ['protein', 'water'] in setup.py for a different name. 
