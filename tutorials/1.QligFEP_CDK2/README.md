#### Why Perform Molecular Dynamics (MD) of a Docking Pose?

The reason for conducting MD of a docking pose is that the initial docking is usually carried out under vacuum conditions, resulting in hypothetical conformations of the protein-ligand complex. To confirm the best pose, it is essential to investigate the system's effects and dynamics in different solvent environments. By performing MD simulations, one gains insights into the stability of various complexes.

#### Workflow Template

To streamline your workflow, you can copy the template folder provided in the repository. This folder contains all the necessary files and resources for the common use case in QligFEP. Specifically, you will need to place your ligand .pdb files in the 1.ligprep folder and your_protein.pdb in the 2.protprep folder.
For each step, move to the folder named as the step itself. 


# 1. Ligand Preparation
We initiate the process with ligands generated in Maestro, typically provided as PDB files. However, to conduct MD simulations, we require specific parameters that are not available initially. Hence, the ligands undergo a crucial step known as ligand preparation.
For correct usage of QligFEP, dock every ligand in the desired protein, find the best pose for it (i.e. Minimised energy, known interactions etc.) and then align all the ligands with similar core region. 
We won't go in detail on how to get to this.

The folder contains pre-generated 3D-coordinates of the ligands, which are not generated by setupFEP. Therefore, it is our responsibility to ensure that these coordinates are reliable. It is essential to bear in mind that FEP handles small changes in the system effectively, but reliable results are obtained only when the phase space sufficiently overlaps. The ligands in this folder share a similar core region, with variations in small substituents being investigated. For AMBER parameters, please refer to qtools.


### 1.1 Generate the files using a script from the script folder. 
To generate the necessary files using a the script located in the script folder, follow these steps:
1. Move to 1.ligprep folder from the template. If you're not using the template provided, create a folder to store your ligands and call it `1.ligprep`:
* `mkdir 1.ligprep`
2. Navigate to the newly created directory:
* `cd 1.ligprep`
3. Place all your ligand.pdb files inside this folder. If your files are in your local machine and you want to use a Cluster, you can use the following command:
* `scp /path/to/local/file username@cluster_ip:/path/on/cluster/`
4. Finally, run the following command to execute the script:
* `python $qligfep/scripts/generate_opls.py`.
This script will produce the necessary .lib, .prm, and .log files required for the third stage.
The .log files are generated by ffld_server.

Important!
  * Make sure that you've exported qligfep to your .bashrc file (or any other of the common Unix shells) so you can call qligfep from a different folder by using `$qligfep`. 
If you haven't, you can do it following these steps:
    1. `cd` to your home folder
    2. `nano ~/.bashrc`
    3. Add this to the end of the file: `export qligfep=/home/USERNAME/QLIGFEP/qligfep`
    - Keep in mind that `/home/USERNAME/QLIGFEP/qligfep` should be replaced with the PATH to your qligfep folder. If you're not sure of what the path to it is, go to your qligfep folder and run `pwd` to find out. Then, simply replace `/home/USERNAME/QLIGFEP/qligfep` with the returned path from pwd. 
    5. Use `source ~/.bashrc` to apply the changes
  

# 2.Protprep
The second step involves preparing the protein for simulations under spherical boundary conditions (SBC). Please note that this script does not assign protonation states, so a preparation step should be executed beforehand (e.g., using Maestro's Protein Preparation Wizard).
The center of the sphere can be determined based on a residue in the protein or, as in this case, by explicitly providing the center of geometry (COG) coordinates from a ligand. 

### 2.1 Obtain COG coordinates. 
To do so run:
`python "$qligfep/scripts/COG.py" -i ligand_path.pdb`

For example, to obtain the COG coordinates used in this example, run:
`python "$qligfep/scripts/COG.py" -i ../1.ligprep/17.pdb`
This will return the coordinates [0.535:26.772:8.819]
! Make sure to **add -i before the pdb file**. 

### 2.2 Add the COG coordinates directly in protprep.py:
`python "$qligfep/protprep.py" -p path_to_protein.pdb -r RADIUS -c COORDINATES -w -P CLUSTER_NAME`

For this tutorial:
- `python "$qligfep/protprep.py" -p 1h1s_PrepWiz.pdb -r 22 -c [0.535:26.772:8.819] -w -P CSB`

After this, you should have three new files in 2.protprep: protPREP.log  protein.pdb  water.pdb.

**Note: Prior to executing the above command, ensure that you have navigated to the folder containing the "1h1s_PrepWiz.pdb" file.**
Furthermore, it is essential to bear in mind that the ligands under investigation share a similar core region, with only minor variations in small substituents. During previous phases, these ligands were superimposed, likely using Maestro. As a result, their centers of geometry are nearly identical. Therefore, we need to perform this process **for just one ligand**, saving time and effort.

# 3.setupFEP
In the next stage we will prepare the input files for the actual simulations.

### 3.1 Prepare input files

#### 3.1.1 Pairs.txt
We need to give QligFEP a list of what pairs should be using each time to calculate ddG. Good practice is to select pairs as similar as possible and go from more complex to less complex. The `pairs.txt`file must contain the name of the ligand (the same as the one in the .pdb file stored in `1.ligprep` folder) **without the .pdb sufix** and separated from one antoher with a single space. Do that for every pair of ligands. 

For example: Let's say we have 4 ligands with different moieties (R): 
Ligand_A( R = 2-F-Benzyl) # stored as ligand_a.pdb in 1.ligprep
Ligand_B( R = Benzyl)  # stored as ligand_b.pdb in 1.ligprep
Ligand_C( R = Propyl)  # stored as ligand_c.pdb in 1.ligprep
Ligand_D( R = Metyl)  # stored as ligand_d.pdb in 1.ligprep
Then the `pairs.txt` should look like this:
ligand_a ligand_b
ligand_c ligand_d
One can also invert the pairs to see if the results are similar as they should be equal in absolute value. So:
ligand_a ligand_b
ligand_b ligand_a
ligand_c ligand_d
ligand_d ligand_c

#### 3.1.2 QligFEP.py
This stage uses `$qligfep/QligFEP.py`. You can use the -h flag to get more specifics on all the input variables. This folder includes a useful top level script, `generate.py`, that takes the pairs.txt file as input that specifies the ligand pairs that will be used in this simulation.

We then run QligFEP.py by running setup.py:
- `python setup.py`

_Note: In this forked version, setup.py is capable of moving the files necessary to use QligFEP.py. If you're using a different version of setup.py, you will have to manually move all the ligands.pbd from `1.ligprep`, the protein.pdb and water.pdb files from `2.protprep`_ in order to do this step. 

This should result in a 1.protein and 2.water folder, containing the two systems necessary to perform the calculation. Simply go into the folder (1.PROTEIN OR 2.WATER), then go into the pair folder whose job you want to submit and run
`./FEP_submit.sh`

This script will either submit your jobs to a slurm queue (see the setup section in $setupFEP/README.md for a more detailed description). Alternatively the jobs can be run on your local machine.
A typical procedure is to put the two systems in a top layer folder to easily track running calculations (e.g. 1.TESTRUN) in the case of this example. Of course, these toplayer scripts can be easily adjusted for any other use (e.g. to calculate solvation free energies, you add a water and vacuum leg, instead of protein water.

If you want to submit all the jobs at once without having to go into each pair folder, you can copy `subimt_all.py` to your `1.protein` or `2.water` folder and then run it. This python script will find all the folders starting as 'FEP_' (basically, all the folders named after the pairs.txt file) and submit their job. 

_Note: Only in this forked version submit_all.py exists. If your using the original repository you will have to submit all the jobs manually or copy the code for submit_all.py from [here](www.google.com) and add it to your workspace._

# 4. Analyze dG in protein and water. 
For this, run:
`python analyze_FEP.py -F path_to_FEP_pair1-pair2_folder -C CLUSTER`
In this tutorial this will be:
`python analyze_FEP.py -F tutorials/1.QligFEP_CDK2/3.setupFEP/1.protein/FEP_22-17 -C CSB` 

_Note: You have to do this from the `QLIGFEP/qligfep` folder. Otherwise it won't work because some python scripts as functions.py cannot be imported._


This will give us the dG calculations for the pair 22-17 in 1.protein. You will have as many FEP_ligand1-ligand2 folders as pairs indicated in the `pairs.txt` file. Thus, you will need to run `analyze_FEP.py` in all of them, for both `1.protein` and `2.water` folders.
Nonetheless, if you want to call analzye_FEP.py for all folders located in 1.protein or 2.water (those named after the pair.txt file: i.e. FEP_17-22) you may use `call_analyzeFEP.py` located in qligfep folder as:
`python call_analyze_FEP.py path_to_1.protein_folder -C CSB` and then `python call_analyze_FEP.py path_to_2.water_folder -C CSB`. 

_Note: Again, this are python scripts only founded in this repository. If you are not using this repository but the original one, you will have to do it manually._

Additionally, you can try using `collect_dG.py` to analyze several folders at once. See the instructions provided on how to use this script below the page. The output of the analysis will contain dG, dGf, dGr, dGos, and dGbar, representing different ways of calculating dG. For most cases, dGbar is used. There will be 10 values corresponding to 10 replicas/runs (although the number of runs can be changed), and some values may be "nan," which is normal. Thanks to changes in this forked repository, SEM is calculated only with existing values (nan values are dropped).
**To change the number of runs**, modify the FEP_submit.sh file located in the path: /home/USER/QLIGFEP/qligfep/tutorials/1.QligFEP_CDK2/3.setupFEP/1.protein/FEP_17-22

So far, we have collected the dG values for each ligand pair in water and in protein. The reason we need both of them in order to calculate the ddG is that we need a complete thermodynamic cycle.

## Following steps:
### Calculating ddG: 
First, we have to ask the question: _Why do we want to calculate ddG in the first place?_
We want to calculate the difference in binding free energy (ddGbind) for two ligands (or several pair of ligands for that matter), beacause it allows us to determine their relative binding affinities to the receptor (usually a protein).

It will be easier to create an excel file. You can download an excel template from [here](https://github.com/afloresep/qligfep/blob/master/ddG_template.xlsx)

In summary, with the help of the template we will calculate: 
1. Average dG for each ligand pair in Protein
 $$\bar{dG_{\text{protein}}} = \frac{\sum_{i=1}^{n} dG_{\text{}, i}}{n_{\text{}}}$$
2. Average dG for each ligand pair in Water
 $$\bar{dG_{\text{water}}} = \frac{\sum_{i=1}^{n} dG_{\text{}, i}}{n_{\text{}}}$$
3. ddG for each pair (ddG(A->B) = AVG(dGprotein) - AVG(dGwater)
$$ddG(A \to B) = \bar{dG_{\text{protein}}} - \bar{dG_{\text{water}}}$$

5. Calculate SEM (Standard Error of the Mean) for protein and water: $$SEM = \frac{\sigma}{\sqrt{n}}$$
6. Calculate SEM final: $$SEM_{f} = \sqrt{SEM_{\text{water}}^2 + SEM_{\text{protein}}^2}$$
Finally we get: 
$$ddG (A \to B) \pm \sqrt{SEM_{\text{water}}^2 + SEM_{\text{protein}}^2}$$

Tipically you will want to compare this results with experimental ones. 
You can calculate experimental ddG from Ki (_constant of inhibition_) using the following formula: 
$$\Delta G^\circ = -RT \ln K$$

### Comparing ddG with experimental data:
So far all we have done is find a theorical value for ddG between several pairs of  ligands. However, this result alone is not good enough since is based on docking poses carried out with very optial conditions. Thus, the real binding mode of the ligands may vary. That raises the need for comparing Theorical ddG with Experimental ddG. If both look similar. There's several ways to calculate ddG from experimental data, the one covered here will be from using Ki (_constant of inhibition_).

Let's see first what is the general formula for calculating dG: 
 ΔG° = -RT ln K
Where:
_R_ is the gas constant with a value of 8.314 J 8.314 J K-1mol-1
T

T is the temperature of the reaction in Kelvin.

ΔG°

It is important to realise that we are talking about standard free energy change here - NOT the free energy change at whatever temperature the reaction was carried out.
 - The Cheng-Prusoff equation is Ki =  IC50/(1+ [S]/Km)
Ki = the inhibitory constant, defined as the equilibrium concentration of an inhibitory ligand when 50% of the receptor sites are occupied if no competing substrate is present.   

IC50 = The concentration at which the inhibitory ligand displaces 50% of the substrate.   

[S] = The concentration of the substrate used in the binding assay.  

Km = the affinity constant of the substrate, defined as the equilibrium concentration that results in substrate occupying 50% of the receptor sites in the absence of competitio

#### How to Use collect_dG.py
`collect_dG.py` is a python script that allows you to call analyze_FEP.py for different folders (usually 1.protein/FEP_pair and 2.water/FEP_pair) with a single command  and stores the results in different .csv files so it's easier to work with the results later on.

To use collect_dG.py, you need to provide at least 4 arguments when calling it on the command line:
- collect_dG.py
- folder_name (the folder where the .csv files will be stored)
- path_to_folder1
- path_to_folder2

and is called from the qligfep folder like this: `python collect_dG.py folder_name path_to_folder1 path_to_folder2`

#### Example for tutorial.
After going trough steps 1, 2, 3 and from `qligfep`folder write
`python collect_dG.py dG-FEP_17-22_2 tutorials/1.QligFEP_CDK2/3.setupFEP/1.protein/FEP_17-22 tutorials/1.QligFEP_CDK2/3.setupFEP/2.water/FEP_17-22`

Now, there should be 2 .csv files dG.csv and dG-1.csv inside the dG-FEP_17-22 folder. Each .csv file contains the path to the folder from which the dG values were calculated along with the calculation results. In later versions, it is expected to create a single .csv file with all the results (problems with merging the files are being addressed).

